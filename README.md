# 人脸识别考勤系统使用文档

## 目录

1. [系统简介](#系统简介)
2. [系统要求](#系统要求)
3. [环境配置](#环境配置)
4. [数据库配置](#数据库配置)
5. [快速开始](#快速开始)
6. [功能模块详解](#功能模块详解)
7. [常见问题](#常见问题)
8. [技术架构](#技术架构)

---

## 系统简介

本系统是一个基于深度学习的人脸识别考勤管理系统，支持：
- ✅ 人脸注册与管理
- ✅ 人脸识别与检测
- ✅ 自动考勤记录
- ✅ 考勤记录增删改查
- ✅ 数据统计与分析

系统采用 PyQt6 构建图形界面，使用 YOLOv8 进行人脸检测，InsightFace 进行特征提取，MySQL 存储数据。

---

## 系统要求

### 硬件要求
- **CPU**: 推荐 Intel i5 或更高
- **内存**: 至少 4GB RAM（推荐 8GB 以上）
- **存储**: 至少 2GB 可用空间（用于模型和数据库）
- **显卡**: 可选（支持 CUDA 的显卡可加速处理）

### 软件要求
- **操作系统**: Windows 10/11, Linux, macOS
- **Python**: 3.8 或更高版本
- **MySQL**: 5.7 或更高版本

---

## 环境配置

### 1. 安装 Python 依赖

```bash
pip install PyQt6
pip install opencv-python
pip install numpy
pip install ultralytics
pip install insightface
pip install pymysql
```

或者使用 requirements.txt（如果提供）：

```bash
pip install -r requirements.txt
```

### 2. 下载模型文件

确保以下文件在项目根目录中：
- `yolov8x-face-lindevs.pt` - 人脸检测模型

InsightFace 模型会在首次运行时自动下载（buffalo_l 模型）。

---

## 数据库配置

### 1. 创建数据库

登录 MySQL，执行以下 SQL：

```sql
CREATE DATABASE IF NOT EXISTS face_recognition DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE face_recognition;
```

### 2. 创建数据表

系统会在首次运行时自动创建所需的表，但您也可以手动创建：

```sql
-- 人脸特征表
CREATE TABLE IF NOT EXISTS face_features (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    feature BLOB NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 考勤记录表（系统会自动创建）
CREATE TABLE IF NOT EXISTS attendance_records (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    attendance_time DATETIME NOT NULL,
    date DATE NOT NULL,
    time TIME NOT NULL,
    INDEX idx_name (name),
    INDEX idx_date (date),
    INDEX idx_attendance_time (attendance_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3. 配置数据库连接

编辑 `database.py` 文件，修改数据库连接参数：

```python
self.conn = pymysql.connect(
    host="localhost",      # 数据库主机地址
    user="root",           # 数据库用户名
    password="123456",     # 数据库密码
    database="face_recognition"  # 数据库名称
)
```

---

## 快速开始

### 1. 启动程序

```bash
python UI.py
```

### 2. 首次运行

程序启动时会自动：
- 加载人脸检测模型
- 加载特征提取模型
- 连接数据库
- 创建必要的表（如果不存在）

### 3. 注册第一个人员

1. 点击 **"注册人脸"** 按钮
2. 点击 **"选择图片"** 选择包含人脸的图片
3. 输入姓名
4. 点击 **"注册人脸"** 完成注册

---

## 功能模块详解

### 一、注册人脸模块

**功能**: 将人员人脸注册到系统中

#### 使用步骤：

1. **选择图片**
   - 点击 **"选择图片"** 按钮
   - 支持格式：`.jpg`, `.png`, `.jpeg`
   - 图片会自动显示在界面中（自动缩放）

2. **输入姓名**
   - 在姓名输入框中输入要注册的人员姓名
   - 姓名不能为空

3. **注册人脸**
   - 点击 **"注册人脸"** 按钮
   - 系统会自动：
     - 检测图片中的人脸
     - 提取人脸特征
     - 检查是否重复
     - 保存到数据库

#### 注意事项：

- ⚠️ **重复姓名检查**: 如果姓名已存在，系统会提示错误
- ⚠️ **重复人脸检查**: 如果检测到与已注册人员相似的人脸（相似度≥0.85），系统会拒绝注册
- ⚠️ **图片要求**: 图片中必须包含清晰可见的人脸，建议使用正面照片
- ✅ 图片会自动缩放以适应显示区域，保持宽高比

---

### 二、检测人脸模块

**功能**: 识别图片中的人脸并自动记录考勤

#### 使用步骤：

1. **选择图片**
   - 点击 **"选择图片"** 按钮
   - 选择包含人脸的图片（支持多人）
   - 图片会自动处理

2. **查看识别结果**
   - 识别到的人脸会用绿色框标注，显示姓名和相似度
   - 未识别的人脸会用红色框标注，显示 "Unknown"

3. **自动考勤记录**
   - 当识别到已注册人员时，系统会自动记录考勤时间
   - 控制台会显示考勤记录成功或失败的消息
   - **防重复机制**: 5分钟内不会重复记录同一人的考勤

#### 识别规则：

- **相似度阈值**: 默认 0.55（可修改 `matcher.py` 中的 `threshold` 参数）
- **相似度越高**: 识别越准确
- **绿色框**: 识别成功，已注册人员
- **红色框**: 未识别，Unknown

---

### 三、删除管理模块

**功能**: 删除已注册的人脸信息

#### 使用步骤：

1. **查看已注册人员**
   - 切换到 **"删除管理"** 页面
   - 列表会显示所有已注册的人员
   - 如果某个姓名有多条记录，会显示记录数量

2. **删除人脸信息**
   - 在列表中选择要删除的人员
   - 点击 **"删除选中项"** 按钮
   - 在确认对话框中点击 **"是"** 确认删除

3. **刷新列表**
   - 点击 **"刷新列表"** 按钮更新人员列表

#### 注意事项：

- ⚠️ **不可恢复**: 删除操作不可恢复，请谨慎操作
- ⚠️ **影响考勤**: 删除人员后，之前的考勤记录仍会保留
- ✅ 删除前会有确认对话框，防止误删

---

### 四、考勤记录模块

**功能**: 查看、添加、修改、删除考勤记录

#### 4.1 查看考勤记录

1. **筛选记录**
   - **按姓名筛选**: 在姓名下拉框中选择要查看的人员（或选择"全部"）
   - **按日期筛选**: 在日期选择器中选择要查看的日期
   - 点击 **"刷新记录"** 查看筛选结果

2. **查看统计信息**
   - 页面底部显示当前筛选条件下的记录总数

3. **清除筛选**
   - 点击 **"清除筛选"** 按钮恢复显示全部记录

#### 4.2 增加考勤记录（手动）

1. 点击 **"增加记录"** 按钮（绿色）
2. 在弹出的对话框中：
   - 选择或输入姓名（可从下拉列表选择已注册人员）
   - 选择考勤时间（支持日期和时间选择器）
3. 点击 **"确定"** 保存记录

#### 4.3 修改考勤记录

1. 在表格中选择要修改的记录（点击行）
2. 点击 **"修改记录"** 按钮（黄色）
3. 在弹出的对话框中修改信息：
   - 可以修改姓名
   - 可以修改考勤时间
4. 点击 **"确定"** 保存修改

#### 4.4 删除考勤记录

1. 在表格中选择要删除的记录
2. 点击 **"删除记录"** 按钮（红色）
3. 在确认对话框中查看记录详情
4. 点击 **"是"** 确认删除

#### 表格说明：

- **姓名**: 考勤人员姓名
- **日期**: 考勤日期
- **时间**: 考勤时间（时分秒）
- **完整时间**: 完整的日期时间戳

---

## 常见问题

### Q1: 程序启动失败，提示模型加载失败？

**A**: 请检查：
1. `yolov8x-face-lindevs.pt` 文件是否在项目根目录
2. 网络连接是否正常（首次运行需要下载 InsightFace 模型）
3. 磁盘空间是否充足

### Q2: 数据库连接失败？

**A**: 请检查：
1. MySQL 服务是否正在运行
2. 数据库连接参数是否正确（`database.py` 文件）
3. 数据库和表是否已创建
4. 数据库用户权限是否足够

### Q3: 识别不准确怎么办？

**A**: 可以尝试：
1. 使用更清晰的正面照片重新注册
2. 调整识别阈值（修改 `matcher.py` 中的 `threshold` 参数）
3. 确保注册照片和检测照片的光线、角度相近

### Q4: 为什么识别到人脸但显示 Unknown？

**A**: 可能原因：
1. 该人脸尚未在系统中注册
2. 相似度低于阈值（默认 0.55）
3. 图片质量较差，特征提取失败

### Q5: 考勤记录重复怎么办？

**A**: 系统有防重复机制（5分钟内不重复记录），如果需要手动删除重复记录：
1. 进入考勤记录页面
2. 筛选找到重复记录
3. 选择并删除

### Q6: 如何修改数据库连接信息？

**A**: 编辑 `database.py` 文件，修改 `FaceDatabase` 类的 `__init__` 方法中的连接参数。

### Q7: 图片显示不完整？

**A**: 系统会自动缩放图片以完整显示，保持宽高比。如果仍有问题，请检查图片文件是否损坏。

### Q8: 如何导出考勤记录？

**A**: 当前版本暂不支持直接导出，但可以：
1. 在考勤记录页面查看数据
2. 使用 MySQL 客户端导出数据
3. 或编写脚本从数据库导出（需要自行实现）

---

## 技术架构

### 核心技术栈

- **GUI框架**: PyQt6
- **图像处理**: OpenCV (cv2)
- **人脸检测**: YOLOv8
- **特征提取**: InsightFace
- **数据库**: MySQL (PyMySQL)
- **数值计算**: NumPy

### 模块说明

1. **detector.py** - 人脸检测模块
   - 使用 YOLOv8 模型检测图片中的人脸位置和关键点

2. **aligner.py** - 人脸对齐模块
   - 基于关键点对齐人脸，统一尺寸和角度

3. **extractor.py** - 特征提取模块
   - 使用 InsightFace 提取人脸特征向量

4. **matcher.py** - 人脸匹配模块
   - 使用余弦相似度匹配人脸特征

5. **database.py** - 数据库操作模块
   - 管理人脸特征数据和考勤记录
   - 提供增删改查接口

6. **UI.py** - 用户界面模块
   - 提供图形化操作界面
   - 整合各功能模块

### 数据流程

```
图片输入 → 人脸检测 → 人脸对齐 → 特征提取 → 特征匹配 → 识别结果
                                              ↓
                                        考勤记录保存
```

---



